<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="Less is More">
<meta property="og:type" content="website">
<meta property="og:title" content="Qi's Blog">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Qi's Blog">
<meta property="og:description" content="Less is More">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Qi's Blog">
<meta name="twitter:description" content="Less is More">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/page/3/"/>

  <title> Qi's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Qi's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">不打无准备之仗</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/25/ssh-keys/" itemprop="url">
                  ssh keys
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-25T17:52:13+08:00" content="2016-10-25">
              2016-10-25
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/ssh-keys/" itemprop="url" rel="index">
                    <span itemprop="name">ssh keys</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/25/ssh-keys/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/25/ssh-keys/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ssh-keys"><a href="#ssh-keys" class="headerlink" title="ssh keys"></a>ssh keys</h1><p>配置多个ssh key:</p>
<p>1.<code>ssh-keygen -t rsa -C &quot;youremail@email.com&quot; -f ~/.ssh/second</code><br>生成新的<code>ssh key</code>并命名为<code>second</code>。或者<code>ssh-keygen -t rsa -C &quot;youremail@email.com&quot;</code> 在询问时定义名称。</p>
<p>这个命令直接通过-f参数指定了密钥和公钥的文件名，比如-f ~/.ssh/second，其生产的密钥为~/.ssh/second，公钥为~/.ssh/second.pub.</p>
<p>2.远程主机添加公钥</p>
<p>把公钥文件中的内容追加到~/.ssh/authorized_keys文件的末尾。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat ~/.ssh/second.pub</div></pre></td></tr></table></figure>
<p>注意追加前authorized_keys文件的末尾需要有个换行符。</p>
<p>3.配置本地config文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># Default github user(first@mail.com)  默认配置，一般可以省略</div><div class="line">Host github.com</div><div class="line">Hostname github.com</div><div class="line">User git</div><div class="line">Identityfile ~/.ssh/github</div><div class="line"># second user(second@mail.com)  给一个新的Host称呼</div><div class="line">Host second.github.com  // 主机名字，不能重名</div><div class="line">HostName github.com   // 主机所在域名或IP</div><div class="line">User git  // 用户名称</div><div class="line">IdentityFile C:/Users/username/.ssh/id_rsa_second  // 私钥路径</div></pre></td></tr></table></figure>
<p>其中User后面的值为你访问的git ssh地址的@之前的部分，比如：git@github.com:dongritengfei/beego.git的@前面是git，所以User后面的值为git。Host就是你的git仓库的域名或者IP。</p>
<p>4.测试链接情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh -T git@second.github.com</div></pre></td></tr></table></figure>
<p>ssh -T 用户名@Host。返回welcome,说明是可以的。</p>
<p>参考</p>
<p>多个密钥管理</p>
<p><a href="https://www.zybuluo.com/yangfch3/note/172120" target="_blank" rel="external">多个 SSH KEY 的管理</a></p>
<p><a href="http://rongmayisheng.com/post/linux%E7%AE%A1%E7%90%86%E5%A4%9A%E4%B8%AAssh%E5%85%AC%E9%92%A5%E5%AF%86%E9%92%A5" target="_blank" rel="external">linux管理多个ssh公钥密钥</a></p>
<p>配置密钥</p>
<p><a href="https://segmentfault.com/a/1190000000481249" target="_blank" rel="external">配置ssh密钥认证自动登录</a></p>
<p>cat -n id_rsa.pub &gt;&gt; authorized_keys。加个换行符比较好</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/24/字符编码/" itemprop="url">
                  字符编码
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-24T22:22:15+08:00" content="2016-10-24">
              2016-10-24
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/编码/" itemprop="url" rel="index">
                    <span itemprop="name">编码</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/24/字符编码/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/24/字符编码/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="字符编码问题"><a href="#字符编码问题" class="headerlink" title="字符编码问题"></a>字符编码问题</h1><p>java：</p>
<p>1.<a href="https://www.oschina.net/question/54100_25358" target="_blank" rel="external">java使用jchardet检测文本文件(字节流)的编码方式</a> wings里面使用的就是这个。</p>
<p>2.<a href="http://geeklu.com/2009/12/dive-into-the-charset-of-java/" target="_blank" rel="external">深度剖析Java的字符编码</a></p>
<p>3.<a href="http://www.cnblogs.com/yejg1212/p/3402322.html" target="_blank" rel="external">java自动探测文件的字符编码</a></p>
<p>4.<a href="http://www.cnblogs.com/amunote/p/4178472.html" target="_blank" rel="external">借助JCharDet获取文件字符集</a></p>
<h3 id="编码教程"><a href="#编码教程" class="headerlink" title="编码教程"></a>编码教程</h3><h4 id="1"><a href="#1" class="headerlink" title="1."></a>1.</h4><ul>
<li><p>ASCII是最基本的，最早的，用的最广泛的，字符编码</p>
</li>
<li><ul>
<li>但是只支持普通的基本字符，即常见英文字母，数字，下划线等</li>
</ul>
</li>
<li><p>简体中文的编码</p>
</li>
<li><ul>
<li>发展路径以此是：GB2312 &lt; GBK &lt; GB18030</li>
<li>对应的所包含的字符个数，也是以此增加</li>
</ul>
</li>
<li><p>繁体中文的编码</p>
</li>
<li><ul>
<li>最常见的是BIG5</li>
</ul>
</li>
<li><p>西欧字符编码</p>
</li>
<li><ul>
<li><p>最常用的就是ISO8895-1</p>
</li>
<li><ul>
<li>ISO8859是从1到15，是一系列的编码</li>
<li>ISO8859-1是属于ISO8859系列编码其下的，但是用的最广泛的的</li>
</ul>
</li>
</ul>
</li>
<li><p>统一了世界上所有字符的Unicode</p>
</li>
<li><ul>
<li><p>Unicode，可以叫做大一统的编码，包含了世界上所有的字符</p>
</li>
<li><p>但是Unicode只是字符编码集</p>
</li>
<li><ul>
<li>字符（编码）集，只表示包含了哪些字符</li>
<li>字符编码，表示了用何种方式去表示此字符集</li>
<li>Unicode这个字符集，可以有多种字符编码表示出来，最常见的包括UTF-8，UTF-16，UTF-32等等</li>
<li>最最常用的是UTF-8</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>网页中的编码，一般是通过charset指定的；很多中文网页，charset用的GB2312；但是部分网页，所声明的编码和实际编码不同：虽然charset指定的是GB2312，但是实际上用的是（包含了更多字符的）GBK；导致的情况是：如果你按照GB2312去解码，由于部分字符是属于GBK的，而非GB2312，则会出现解码失败。解决办法是：尝试用GBK，或包含更多字符的GB18030去解码，则一般都可以正常解码的。</p>
<p>参见<a href="http://www.crifan.com/character_encoding_charset_simpile_tutorial/" target="_blank" rel="external">字符编码简明教程</a></p>
<h4 id="2"><a href="#2" class="headerlink" title="2."></a>2.</h4><p>当你通过浏览器，打开某个网站，即某个url地址的时候，你所能正常看到网页的内容，各种文字，都可以正常显示，且没有显示乱码。此过程，涉及到，浏览器帮你正确解析HTML源码。</p>
<p>流程如下所示：</p>
<p>1.浏览器访问对应的url地址，并获取对应的html（或者，以及，其他的css，javascript等）网页源码</p>
<p>2.浏览器识别解析HTML源码内容</p>
<p>其中包含了，解析html的头部（header），找到对应的charset=xxx这部分的内容，然后把根据xxx所指示的字符编码类型，去解码对应的html内容，显示对应的文字，以保证不是乱码，可以正确的显示文字信息；</p>
<blockquote>
<p>所以爬虫在抓取了网页的源代码后，也要跟浏览器一样去对网页进行解码。</p>
</blockquote>
<p>注：有个别的html网页本身做的不规范，导致本身自己声明的是某种编码类型，但是实际上，并不全是该类型的编码，导致你去按照其所声明的编码去解析，有时候仍会出现乱码。比如，其html中明明写的是charset=gb2312，但是实际上，其部分字符是属于GBK的，导致你按照gb2312去解码，有些字符仍会是乱码，而安装gbk去解码，就全都正常显示了，没有乱码了。即实际上应该是charset=gbk。</p>
<h3 id="python编码问题"><a href="#python编码问题" class="headerlink" title="python编码问题"></a>python编码问题</h3><blockquote>
<p>乱码问题是我原本用的某种编码方式，如果要进行解码，也应该要用对应的解码格式去解码，或者用兼容性更大的，比如gb2312，也可以用gbk或gb18030去解码，但不能用utf-8去解码，虽然他能表达的编码更多。</p>
<p>GB2312，GBK，GB18030，编码技术上都是兼容的。</p>
</blockquote>
<p>参见写的很不错的这篇</p>
<p><a href="http://www.crifan.com/eclipse_pydev_console_messy_char_for_console_is_utf8/" target="_blank" rel="external">python解析网页源代码返回乱码问题</a></p>
<p>抓取的网页是gb2312的，然后直接输出到console里面是乱码，原因是console采用的是utf-8编码的，解决方案</p>
<p>1.run Configuration，修改console的编码，从UTF-8改为GBK（或GB2312，或GB18030)。</p>
<p>2.修改代码获得GB2312的html后，去decode为Unicode，然后直接输出Unicode字符串到UTF-8的Eclipse+PyDev的console中，</p>
<p>则比如也是可以正常显示无乱码的。(内部会自动将输出的Unicode转换为当前console的UTF-8编码的字符串的)。</p>
<p>3.基于上面那种方式，(不改Eclipse+PyDev的console的字符编码，仍保持旧的UTF-8的配置)，但是在转换为Unicode后，再故意转为输出目标（此处的Eclipse+PyDev的console）的编码，即UTF-8。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">uniCodehtml = html.decode(&quot;GBK&quot;) //此处只是转化为了unicode，并不是utf-8</div><div class="line">utf8html = uniCodehtml.encode(&quot;UTF-8&quot;)</div><div class="line">print utf8html</div></pre></td></tr></table></figure>
<h5 id="关于beautifulsoup的总结"><a href="#关于beautifulsoup的总结" class="headerlink" title="关于beautifulsoup的总结"></a>关于beautifulsoup的总结</h5><p>以后用python的Beautiful Soup去解析中文网页的话：</p>
<p>1.如果本身网页的编码自己标称的，和本身其中文字符所用编码完全符合的话，即没有部分字符超出了其所标称的编码，比如标称为GBK，网页所有的内容，都的确是GBK编码，没有超出的其他字符（比如属于GB18030的编码），那么，是可以通过：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">page = urllib2.urlopen(url)</div><div class="line">soup = BeautifulSoup(page) #此处不需要传递参数，BeautifulSoup也完全可以自己去解析网页内容所使用的编码</div><div class="line">print soup.originalEncoding</div></pre></td></tr></table></figure>
<p>而得到真实的网页的编码的。</p>
<p> 2.讨论中文乱码问题之前，先解释关于中文字符编码：</p>
<p>时间上的发展先后是，GB2312，GBK，GB18030，编码技术上都是兼容的。</p>
<p>从所包含的中文字符个数来说，算是：GB2312 &lt; GBK &lt; GB18030，也因此，才可能会出现上面所说的，标称GB2312的，部分字符用到了GBK里面的，或者是标称GBK的，部分字符用到了GB18030里面的，所以被人家编码工具解析错误，退回认为编码是最基本的windows-2152了。</p>
<p>所以：</p>
<p>（1）如果是网页标称为GB2312，但是部分字符用到了GBK的了，那么解决办法就是在调用BeautifulSoup，传递参数fromEncoding=”GBK”</p>
<p>（2）如果是网页标称为GBK，但是部分字符用到了GB18030的了，那么解决办法就是在调用BeautifulSoup，传递参数fromEncoding=”GB18030”。</p>
<p>（3）实际上由于GB18030从字符数上都涵盖了GB2312和GBK，所以如果是上述两种任意情况，即只要是中文字符出现乱码，不管是标称GB2312中用到了GBK，还是标称GBK中用到了GB18030，那么都直接传递GB18030，也是可以的，即：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">soup = BeautifulSoup(page, fromEncoding=&quot;GB18030&quot;)</div></pre></td></tr></table></figure>
<p>参见<a href="http://powerelite.blog.163.com/blog/static/429658912014394820777/" target="_blank" rel="external">python中文字符乱码（GB2312，GBK，GB18030相关的问题）</a></p>
<p>可能遇到的坑: beautifulsoup在输出文本时默认以UTF-8的方式编码，无论原文是否以它进行编码的.即即使你用了正确的编码格式，如gb18030，但是beautifulsoup默认是使用utf-8输出，所以依旧乱码。</p>
<p>参见<a href="http://www.jianshu.com/p/69401b84419e" target="_blank" rel="external">requests和BeautifulSoup中文编码转换心得</a></p>
<h5 id="chardet代码"><a href="#chardet代码" class="headerlink" title="chardet代码"></a>chardet代码</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; import urllib</div><div class="line">&gt;&gt;&gt; rawdata = urllib.urlopen(&apos;http://www.google.cn/&apos;).read()</div><div class="line">&gt;&gt;&gt; import chardet</div><div class="line">&gt;&gt;&gt; chardet.detect(rawdata)</div><div class="line">&#123;&apos;confidence&apos;: 0.98999999999999999, &apos;encoding&apos;: &apos;GB2312&apos;&#125;</div></pre></td></tr></table></figure>
<h5 id="encode-amp-decode"><a href="#encode-amp-decode" class="headerlink" title="encode &amp; decode"></a>encode &amp; decode</h5><blockquote>
<p>字符串在Python内部的表示是unicode编码，因此，在做编码转换时，通常需要以unicode作为中间编码，即先将其他编码的字符串解码（decode）成unicode，再从unicode编码（encode）成另一种编码。</p>
</blockquote>
<p>decode的作用是将其他编码的字符串转换成unicode编码，如str1.decode(‘gb2312’)，表示将gb2312编码的字符串str1转换成unicode编码。</p>
<p>encode的作用是将unicode编码转换成其他编码的字符串，如str2.encode(‘gb2312’)，表示将unicode编码的字符串str2转换成gb2312编码。</p>
<p>因此，转码的时候一定要先搞明白，字符串str是什么编码，然后decode成unicode，然后再encode成其他编码。</p>
<blockquote>
<p>代码中字符串的默认编码与代码文件本身的编码一致。</p>
</blockquote>
<p>如：s=’中文’。如果是在utf8的文件中，该字符串就是utf8编码，如果是在gb2312的文件中，则其编码为gb2312。这种情况下，要进行编码转换，都需 要先用decode方法将其转换成unicode编码，再使用encode方法将其转换成其他编码。</p>
<p>通常，在没有指定特定的编码方式时，都是使用的系统默 认编码创建的代码文件。如果字符串是这样定义：s=u’中文’，则该字符串的编码就被指定为unicode了，即python的内部编码，而与代码文件本身的编码无关。因此，对于这种情况做编码转换，只需要直接使用encode方法将其转换成指定编码即可。</p>
<p>如果一个字符串已经是unicode了，再进行解码则将出错，因此通常要对其编码方式是否为unicode进行判断：</p>
<p>isinstance(s, unicode) #用来判断是否为unicode，用非unicode编码形式的str来encode会报错</p>
<p>如何获得系统的默认编码？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line">#coding=utf-8</div><div class="line">import sys</div><div class="line">print sys.getdefaultencoding()</div></pre></td></tr></table></figure>
<p>该段程序在英文WindowsXP上输出为：ascii。</p>
<p>在某些IDE中，字符串的输出总是出现乱码，甚至错误，其实是由于IDE的结果输出控制台自身不能显示字符串的编码，而不是程序本身的问题。</p>
<p>如在UliPad中运行如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">s=u&quot;中文&quot;</div><div class="line">print s</div></pre></td></tr></table></figure>
<p>会提示：UnicodeEncodeError: ‘ascii’ codec can’t encode characters in position 0-1: ordinal not in range(128)。这是因为UliPad在英文WindowsXP上的控制台信息输出窗口是按照ascii编码输出的（英文系统的默认编码是 ascii），而上面代码中的字符串是Unicode编码的，所以输出时产生了错误。</p>
<p>将最后一句改为：print s.encode(‘gb2312’)，则能正确输出“中文”两个字。</p>
<p>若最后一句改为：print s.encode(‘utf8’)，则输出：\xe4\xb8\xad\xe6\x96\x87，这是控制台信息输出窗口按照ascii编码输出utf8编码的字符串的结果。</p>
<p>unicode(str,’gb2312’)与str.decode(‘gb2312’)是一样的，都是将gb2312编码的str转为unicode编码。</p>
<p>使用str.<strong>class</strong>可以查看str的编码形式。</p>
<p>特别推荐这篇:</p>
<p><a href="http://blog.csdn.net/waleking/article/details/7600328" target="_blank" rel="external">python新手必碰到的问题—encode与decode，中文乱码</a></p>
<p>2.</p>
<p>处理流程，可以这么使用，把python看做一个水池，一个入口，一个出口</p>
<p>入口处，全部转成unicode, 池里全部使用unicode处理，出口处，再转成目标编码(当然，有例外，处理逻辑中要用到具体编码的情况)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">读文件</div><div class="line"></div><div class="line">外部输入编码，decode转成unicode</div><div class="line"></div><div class="line">处理(内部编码，统一unicode)</div><div class="line"></div><div class="line">encode转成需要的目标编码</div><div class="line"></div><div class="line">写到目标输出(文件或控制台)</div></pre></td></tr></table></figure>
<p>IDE和控制台报错，原因是print时，编码和IDE自身编码不一致导致</p>
<p>输出时将编码转换成一致的就可以正常输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; print u&apos;中文&apos;.encode(&apos;gbk&apos;)</div><div class="line">����</div><div class="line">&gt;&gt;&gt; print u&apos;中文&apos;.encode(&apos;utf-8&apos;)</div><div class="line">中文</div></pre></td></tr></table></figure>
<p>处理顺序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1. Decode early</div><div class="line">2. Unicode everywhere</div><div class="line">3. Encode later</div></pre></td></tr></table></figure>
<p>引用自<a href="http://wklken.me/posts/2013/08/31/python-extra-coding-intro.html" target="_blank" rel="external">PYTHON-进阶-编码处理小结</a></p>
<h5 id="3"><a href="#3" class="headerlink" title="3."></a>3.</h5><p>在python中，使用unicode类型作为编码的基础类型，编解码要以其为中间形式过渡，即进行<code>str</code>和<code>unicode</code>之间的转换。<br>解码然后再编码的过程，即<code>str</code>-&gt;<code>unicode</code>-&gt;<code>str</code>的过程。中间得到的叫做unicode对象。</p>
<p>这里需要强调的是unicode是一种字符编码方法，是 “与存储无关的表示”，而utf8是一种以unicode进行编码的计算机二进制表示，或者说传输规范。gbk，gb2312，gb18030, utf8等属于不同的字符集，转换编码就是在它们中的任意两者间进行。</p>
<p>具体的转换，比如直接将一个字符串encode成另一种字符集表示，注意此处是字符串，即<code>type</code>为<code>str</code>的，引号前没有加<code>u</code>前缀的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># coding: utf8</div><div class="line">s=&apos;美丽&apos;</div><div class="line">s.encode(&apos;gbk&apos;)</div></pre></td></tr></table></figure>
<p>则实际上会先以默认编码进行<code>decode</code>，即<code>decode(&#39;ascii&#39;)</code>(假设系统默认的是)，开头声明了utf8，<code>s</code>的编码就是<code>utf8</code>，ascii解码不了<code>utf8</code>的字符会报错。那就改默认编码，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># coding: utf8</div><div class="line">import sys</div><div class="line"></div><div class="line">reload(sys)</div><div class="line">sys.setdefaultencoding(&apos;utf-8&apos;)</div><div class="line"></div><div class="line">s=&apos;美丽&apos;</div><div class="line">s.encode(&apos;gbk&apos;)</div></pre></td></tr></table></figure>
<p>这样把默认编码改成utf8，<code>decode</code>的时候就以默认编码<strong>utf8</strong>来进行，能够成功运行.</p>
<p>或者<code>decode</code>时指定类型，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># coding: utf8</div><div class="line">import sys</div><div class="line"></div><div class="line">s=&apos;美丽&apos;</div><div class="line">s.decode(&apos;utf8&apos;).encode(&apos;gbk&apos;)</div></pre></td></tr></table></figure>
<p>对于<code>type</code>为<code>unicode</code>的，即加了<code>u</code>前缀的字符串，如上所说，直接<code>encode</code>即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># coding: utf8</div><div class="line">import sys</div><div class="line"></div><div class="line">s = u&apos;美丽&apos;</div><div class="line">s.encode(&apos;gbk&apos;)</div></pre></td></tr></table></figure>
<h3 id="java编码"><a href="#java编码" class="headerlink" title="java编码"></a>java编码</h3><p>1.</p>
<p>JVM里面的任何字符串资源都是Unicode，就是说，任何String类型的数据都是Unicode编码。没有例外。既然只有一种编码，那么，我们可以这么说，JVM里面的String是不带编码的。String相当于 char[]。<br>JVM里面的 byte[] 数据是带编码的。比如，Big5，GBK，GB2312，UTF-8之类的。<br>一个GBK编码的byte[] 转换成 String，其实就是从GBK编码向Unicode编码转换。<br>一个String转换成一个Big5编码的byte[]，其实就是从Unicode编码向Big5编码转换。所以，Unicode是所有编码转换的中间介质。所有的编码都有一个转换器可以转换到Unicode，而Unicode也可以转换到其他所有的编码。这样构成了一个总线结构。</p>
<p>最容易出问题的地方是浏览器和服务器JVM之间.我们把浏览器编码叫做 Browser_Charset，把JVM编码叫做JVM_Charset（通常等于服务器系统编码）。<br>当浏览器的数据过来的时候，是一个带有Browser_Charset的byte[]。<br>如果用户处理程序需要一个String类型的数据，那么JVM会好心好意地把这个byte[]转换成String。使用的转换器是 JVM_Charset -&gt; Unicode。<br>注意，如果这个时候，Browser_Charset 和 JVM_Charset并不相等。那么，这个自动转换是错误的。<br>为了弥补这个错误。我们需要做两步工作。<br>(1) Unicode -&gt; JVM_Charset，把这个String 转换回到原来的 byte[]。<br>(2) Browser_Charset -&gt; Unicode，把这个还原的byte[]转换成 String。</p>
<p>这个效果，和直接从HTTP Request取得byte[]，然后执行 (2) Browser_Charset -&gt; Unicode 的效果是一样的。如果在Request里面设置了CharacterEncoding，那么POST Data参数就不需要自己手工转换了，web server的自动转换就是正确的。URL的参数编码还涉及到URL编码，需要考虑的问题多一些，没有这么简单。</p>
<p>JVM把数据发到浏览器的时候。也需要考虑编码问题。可以在Response里面设置。另外，HTML Meta Header里面也可以设置编码，提醒Browser选择正确编码。</p>
<p>2.</p>
<h5 id="JAVA中字符的表达"><a href="#JAVA中字符的表达" class="headerlink" title="JAVA中字符的表达"></a>JAVA中字符的表达</h5><p>JAVA 中有char、byte、String这几个概念。char 指的是一个UNICODE字符，为16位的整数。byte 是字节，字符串在网络传输或存储前需要转换为byte数组。在从网络接收或从存储设备读取后需要将byte数组转换成String。String是字符串，可以看成是由char组成的数组。String 和 char 为内存形式，byte是网络传输或存储的序列化形式。</p>
<h5 id="编码方式的简介"><a href="#编码方式的简介" class="headerlink" title="编码方式的简介"></a>编码方式的简介</h5><p>String序列化成byte数组或反序列化时需要选择正确的编码方式。如果编码方式不正确，就会得到一些0x3F的值。</p>
<h5 id="J2SE中相关的函数"><a href="#J2SE中相关的函数" class="headerlink" title="J2SE中相关的函数"></a>J2SE中相关的函数</h5><blockquote>
<p>String是unicode，所以new String()得到的是unicode，str.getBytes()得到的是带编码格式的bytes。两种bytes互相转换需要通过unicode。然后，对于console里面的输出，他跟输出到文本是一样的，console和文件一样，且关联系统的编码。console里面的编码如果与之前编码的不一致的话，就会出现乱码现象。</p>
</blockquote>
<p>String str =”英”;<br>//取得GB2312编码的字节<br>byte[] bytesGB2312 = str.getBytes(“GB2312”);<br>//取得平台缺省编码的字节(solaris为ISO8859_1,windows为GB2312)<br>byte[] bytesDefault = str.getBytes();<br>//用指定的编码将字节转换成字符串<br>String newStrGB = new String(bytesGB2312, “GB2312”);</p>
<p>//用平台缺省的编码将字节转换成字符串(solaris为ISO8859_1,windows为GB2312)<br>String newStrDefault = new String(bytesDefault);<br>//用指定的编码从字节流里面读取字符<br>InputStream in = xxx;<br>InputStreamReader reader = InputStreamReader( in, “GB2312”);<br>char aChar = reader.read();</p>
<h5 id="JSP、数据库的编码"><a href="#JSP、数据库的编码" class="headerlink" title="JSP、数据库的编码"></a>JSP、数据库的编码</h5><p>1.JSP中的编码<br>(1) 静态声明:<br>CHARSET有两个作用：<br>JSP文件的编码方式：在读取JSP文件、生成JAVA类时，源JSP文件中汉字的编码<br>JSP输出流的编码方式：在执行JSP时，往response流里面写入数据的编码方式<br>(2) 动态改变:在往response流里面写数据前可以调用response.setContentType()，设定正确的编码类型。<br>(3) 在TOMCAT中，由Request.getParameter() 得到的参数，编码方式都是ISO8859_1。所以如果在浏览器输入框内输入一个汉字“英”，在服务器端就得到一个ISO8859_1编码的（0x00,0xD3,0x00,0xA2）。所以通常在接收参数时转码：<br>String wrongStr = response.getParameter(“name”);<br>String correctStr = new String(wrongStr.getBytes(“ISO8859_1”),”GB2312”);<br>在最新的SERVLET规范里面，也可以在获取参数之前执行如下代码：<br>request.setCharacterEncoding(“GB2312”);</p>
<p>2.数据库的编码</p>
<p>(1) 数据库使用UTF-16<br>如果String中是UNICODE字符，写入读出时不需要转码<br>(2) 数据库使用ISO8859_1<br>如果String中是UNICODE字符，写入读出时需要转码<br>写入：String newStr = new String(oldStr.getByte(“GB2312”), “ISO8859_1”);<br>读出：String newStr = new String(oldStr.getByte(“ISO8859_1”),”GB2312”);</p>
<p>3.</p>
<p>String newStr = new String(oldStr.getBytes(), “UTF-8”);</p>
<p>java中的String类是按照unicode进行编码的，当使用String(byte[] bytes, String encoding)构造字符串时，encoding所指的是bytes中的数据是按照那种方式编码的，而不是最后产生的String是什么编码方式，换句话说，是让系统把bytes中的数据由encoding编码方式转换成unicode编码。如果不指明，bytes的编码方式将由jdk根据操作系统决定。</p>
<p>当我们从文件中读数据时，最好使用InputStream方式，然后采用String(byte[] bytes, String encoding)指明文件的编码方式。不要使用Reader方式，因为Reader方式会自动根据jdk指明的编码方式把文件内容转换成unicode 编码。</p>
<p>当我们从数据库中读文本数据时，采用ResultSet.getBytes()方法取得字节数组，同样采用带编码方式的字符串构造方法即可。</p>
<p>ResultSet rs;<br>bytep[] bytes = rs.getBytes();<br>String str = new String(bytes, “gb2312”);</p>
<p>不要采取下面的步骤。</p>
<p>ResultSet rs;<br>String str = rs.getString();<br>str = new String(str.getBytes(“iso8859-1”), “gb2312”);</p>
<p>这种编码转换方式效率底。之所以这么做的原因是，ResultSet在getString()方法执行时，默认数据库里的数据编码方式为 iso8859-1。系统会把数据依照iso8859-1的编码方式转换成unicode。使用str.getBytes(“iso8859-1”)把数据还原，然后利用new String(bytes, “gb2312”)把数据从gb2312转换成unicode，中间多了好多步骤。</p>
<p>从HttpRequest中读参数时，利用reqeust.setCharacterEncoding()方法设置编码方式，读出的内容就是正确的了。</p>
<p>以上参见<a href="http://blog.sina.com.cn/s/blog_000598fc0100tvlz.html" target="_blank" rel="external">JAVA 字符串编码总结</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/24/eclipse/" itemprop="url">
                  eclipse
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-24T17:37:16+08:00" content="2016-10-24">
              2016-10-24
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/部署/" itemprop="url" rel="index">
                    <span itemprop="name">部署</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/24/eclipse/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/24/eclipse/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><p>如果部署项目后发现访问不了，出现404，原因可能是：</p>
<p>1.路径错误</p>
<p>2.web.xml映射路径写错</p>
<p>3.服务器设置</p>
<p>1）eclipse自带的wtwebapp 2) tomcat webapp</p>
<p>4.jar包没有导进入或者没有随项目发布：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">严重: Error configuring application listener of class org.springframework.web.context.ContextLoaderListener java.lang.ClassNotFoundException: org.springframework.web.context.ContextLoaderListener 	at org.Apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1647) 	at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1493) 	at org.apache.catalina.core.StandardContext.listenerStart(StandardContext.java:4115) 	at org.apache.catalina.core.StandardContext.start(StandardContext.java:4671) 	at org.apache.catalina.core.ContainerBase.start(ContainerBase.java:1053) 	at org.apache.catalina.core.StandardHost.start(StandardHost.java:785) 	at org.apache.catalina.core.ContainerBase.start(ContainerBase.java:1053) 	at org.apache.catalina.core.StandardEngine.start(StandardEngine.java:463) 	at org.apache.catalina.core.StandardService.start(StandardService.java:525) 	at org.apache.catalina.core.StandardServer.start(StandardServer.java:701) 	at org.apache.catalina.startup.Catalina.start(Catalina.java:585) 	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) 	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39) 	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25) 	at java.lang.reflect.Method.invoke(Method.java:597) 	at org.apache.catalina.startup.Bootstrap.start(Bootstrap.java:289) 	at org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:414)</div></pre></td></tr></table></figure>
<p>解决方法：设置deployment assembly。add——&gt;java build path entries——&gt;maven dependencies —&gt;finish.</p>
<p>以后出现404，可以去发布的目录下查看，是否存在项目，然后，</p>
<p>1.检查项目的包是否完整，比如缺少javax.servlet.http之类的（对于这种问题，直接引入包，而不是依赖于server）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">	&lt;groupId&gt;javax.servlet&lt;/groupId&gt;</div><div class="line">	&lt;artifactId&gt;javax.servlet-api&lt;/artifactId&gt;</div><div class="line">	&lt;version&gt;3.1.0&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<p>2.检查是否项目目录下把那些包拷过去了。</p>
<blockquote>
<p>以后碰到这种问题，第一反应就是跑到部署的目录下面去，看看它是否缺jar包，缺文件等等。再者就是看deploy assembly下面是否设置正确了。</p>
</blockquote>
<p>maven install出现必须要idk 1.7之上才支持什么表达式，是因为ArrayList<string> list=ArrayList&lt;&gt;();   &lt;&gt;这个表达式得1.7之上支持。</string></p>
<p>解决方法：在build里面加入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;plugins&gt;</div><div class="line">			&lt;plugin&gt;</div><div class="line">				&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</div><div class="line">				&lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</div><div class="line">				&lt;version&gt;2.3.2&lt;/version&gt;</div><div class="line">				&lt;configuration&gt;</div><div class="line">					&lt;source&gt;1.8&lt;/source&gt;</div><div class="line">					&lt;target&gt;1.8&lt;/target&gt;</div><div class="line">				&lt;/configuration&gt;</div><div class="line">			&lt;/plugin&gt;</div><div class="line">		&lt;/plugins&gt;</div></pre></td></tr></table></figure>
<p>附：</p>
<p>maven配置web项目：</p>
<p><a href="http://www.jianshu.com/p/a92831ab2f92" target="_blank" rel="external">http://www.jianshu.com/p/a92831ab2f92</a></p>
<p><a href="https://my.oschina.net/u/2430057/blog/549029" target="_blank" rel="external">https://my.oschina.net/u/2430057/blog/549029</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/19/日志配置/" itemprop="url">
                  日志配置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-19T17:19:44+08:00" content="2016-10-19">
              2016-10-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/logging/" itemprop="url" rel="index">
                    <span itemprop="name">logging</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/19/日志配置/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/19/日志配置/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="日志配置"><a href="#日志配置" class="headerlink" title="日志配置"></a>日志配置</h1><h3 id="在spring中配置日志"><a href="#在spring中配置日志" class="headerlink" title="在spring中配置日志"></a>在spring中配置日志</h3><p>1.让 spring-context 排除对 commons-logging 的依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-context&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;$&#123;spring-version&#125;&lt;/version&gt;</div><div class="line">    &lt;scope&gt;runtime&lt;/scope&gt;</div><div class="line">    &lt;exclusions&gt;</div><div class="line">	&lt;exclusion&gt;</div><div class="line">	    &lt;artifactId&gt;commons-logging&lt;/artifactId&gt;</div><div class="line">	    &lt;groupId&gt;commons-logging&lt;/groupId&gt;</div><div class="line">	&lt;/exclusion&gt;</div><div class="line">    &lt;/exclusions&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<p>2.添加 slf4j-api 和 jcl-over-slf4j 配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;$&#123;slf4j-version&#125;&lt;/version&gt;</div><div class="line">    &lt;scope&gt;runtime&lt;/scope&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;jcl-over-slf4j&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;$&#123;slf4j-version&#125;&lt;/version&gt;</div><div class="line">    &lt;scope&gt;runtime&lt;/scope&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;slf4j-simple&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;$&#123;slf4j-version&#125;&lt;/version&gt;</div><div class="line">    &lt;scope&gt;runtime&lt;/scope&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<p>3.如果是web项目，则配置web.xml文件的Log4jConfigLocation和Log4jConfigListener</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;listener&gt; </div><div class="line">&lt;listener-class&gt;org.springframework.web.util.Log4jConfigListener&lt;/listener-class&gt; </div><div class="line">&lt;/listener&gt; </div><div class="line">&lt;context-param&gt; </div><div class="line">  &lt;param-name&gt;log4jConfigLocation&lt;/param-name&gt; </div><div class="line">  &lt;param-value&gt;WEB-INF/classes/log4j.properties&lt;/param-value&gt; </div><div class="line">&lt;/context-param&gt;</div></pre></td></tr></table></figure>
<p>4.在当前classpath中添加log4j.properties配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">log4j.rootCategory=info, stdout </div><div class="line">log4j.appender.stdout=org.apache.log4j.ConsoleAppender </div><div class="line">log4j.appender.stdout.layout=org.apache.log4j.PatternLayout </div><div class="line">log4j.appender.stdout.layout.ConversionPattern=%d&#123;ABSOLUTE&#125; %5p %t %c&#123;2&#125;:%L - %m%n</div></pre></td></tr></table></figure>
<p>问题：</p>
<p>1.若打印出了SLF4J: Class path contains multiple SLF4J bindings，说明jar包冲突了。slf4j就是所谓的门面模式，提供了一个接口，自己不去实现，让其他日志jar包去实现这个接口。logback、log4j什么的，都有实现这个接口，但运行的时候，必须保证只能有一个接口实现类，如果有两个或以上，就抛上面那个异常了。做下依赖排除就行了，有的时候是其他包里面引进了日志包，不是你自己引进的。</p>
<p>参考博客：</p>
<p><a href="http://www.pythonhk.com/artile/view/1150" target="_blank" rel="external">Spring配置日志</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/18/maven/" itemprop="url">
                  maven
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-18T14:49:22+08:00" content="2016-10-18">
              2016-10-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/maven/" itemprop="url" rel="index">
                    <span itemprop="name">maven</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/18/maven/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/18/maven/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="maven"><a href="#maven" class="headerlink" title="maven"></a>maven</h1><p><a href="http://stamen.iteye.com/blog/1554987" target="_blank" rel="external">Maven解决类包依赖冲突</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/18/mac上的抓包工具/" itemprop="url">
                  mac上的抓包工具
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-18T14:46:34+08:00" content="2016-10-18">
              2016-10-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/抓包/" itemprop="url" rel="index">
                    <span itemprop="name">抓包</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/18/mac上的抓包工具/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/18/mac上的抓包工具/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="mac上的抓包工具"><a href="#mac上的抓包工具" class="headerlink" title="mac上的抓包工具"></a>mac上的抓包工具</h1><p><a href="http://blog.csdn.net/liulanghk/article/details/46342205" target="_blank" rel="external">网络抓包神器-Charles使用指南</a></p>
<p>问题：怎么抓java程序发出的网络请求</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/18/java-httpclient/" itemprop="url">
                  java-httpclient
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-18T14:44:36+08:00" content="2016-10-18">
              2016-10-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/httpclient/" itemprop="url" rel="index">
                    <span itemprop="name">httpclient</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/18/java-httpclient/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/18/java-httpclient/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="HTTPCLIENT"><a href="#HTTPCLIENT" class="headerlink" title="HTTPCLIENT"></a>HTTPCLIENT</h2><p>httpclient又可分为</p>
<ul>
<li>httpclient3.x</li>
<li>httpclient4.x到httpclient4.3以下</li>
<li>httpclient4.3以上</li>
</ul>
<p>不同httpclient版本其请求发送的方式也不一样,参见</p>
<p><a href="http://spjich.iteye.com/blog/2227931" target="_blank" rel="external">HttpClient 4.3与4.3版本以下版本比较</a></p>
<h4 id="Util工具类"><a href="#Util工具类" class="headerlink" title="Util工具类"></a>Util工具类</h4><p><a href="http://blog.csdn.net/happylee6688/article/details/47148227" target="_blank" rel="external">HttpClient 发送 HTTP、HTTPS 请求的简单封装</a></p>
<p>注：此代码有问题，stringEntity.setContentEncoding(“UTF-8”); 这句应该注调，里面传的参数应该是header类型。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/17/elasticsearch权威指南/" itemprop="url">
                  elasticsearch权威指南
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-17T09:48:38+08:00" content="2016-10-17">
              2016-10-17
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">elasticsearch</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/17/elasticsearch权威指南/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/17/elasticsearch权威指南/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="elasticsearch-权威指南"><a href="#elasticsearch-权威指南" class="headerlink" title="elasticsearch 权威指南"></a>elasticsearch 权威指南</h1><h3 id="3-数据"><a href="#3-数据" class="headerlink" title="3.数据"></a>3.数据</h3><h5 id="3-5更新"><a href="#3-5更新" class="headerlink" title="3.5更新"></a>3.5更新</h5><p>文档在Elasticsearch中是不可变的——我们不能修改他们。如果需要更新已存在的文档，我们可以使用《索引文档》章节提到的<code>index</code> API <em>重建索引(reindex)</em> 或者替换掉它。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">PUT /website/blog/123</div><div class="line">&#123;</div><div class="line">  &quot;title&quot;: &quot;My first blog entry&quot;,</div><div class="line">  &quot;text&quot;:  &quot;I am starting to get the hang of this...&quot;,</div><div class="line">  &quot;date&quot;:  &quot;2014/01/02&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在响应中，我们可以看到Elasticsearch把<code>_version</code>增加了。</p>
<p>1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;_index&quot; :   &quot;website&quot;,</div><div class="line">  &quot;_type&quot; :    &quot;blog&quot;,</div><div class="line">  &quot;_id&quot; :      &quot;123&quot;,</div><div class="line">  &quot;_version&quot; : 2,</div><div class="line">  &quot;created&quot;:   false &lt;1&gt;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><1> <code>created</code>标识为<code>false</code>因为同索引、同类型下已经存在同ID的文档。</1></li>
</ul>
<p>在内部，Elasticsearch已经标记旧文档为删除并添加了一个完整的新文档。旧版本文档不会立即消失，但你也不能去访问它。Elasticsearch会在你继续索引更多数据时清理被删除的文档。</p>
<p>在本章的后面，我们将会在《局部更新》中探讨<code>update</code> API。这个API <em>似乎</em> 允许你修改文档的局部，但事实上Elasticsearch遵循与之前所说完全相同的过程，这个过程如下：</p>
<ol>
<li>从旧文档中检索JSON</li>
<li>修改它</li>
<li>删除旧文档</li>
<li>索引新文档</li>
</ol>
<h5 id="3-6创建"><a href="#3-6创建" class="headerlink" title="3.6创建"></a>3.6创建</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">PUT /website/blog/123/_create</div><div class="line">&#123; </div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="3-9局部更新"><a href="#3-9局部更新" class="headerlink" title="3.9局部更新"></a>3.9局部更新</h5><h5 id="文档局部更新"><a href="#文档局部更新" class="headerlink" title="文档局部更新"></a>文档局部更新</h5><p>在《更新文档》一章，我们说了一种通过检索，修改，然后重建整文档的索引方法来更新文档。这是对的。然而，使用<code>update</code> API，我们可以使用一个请求来实现局部更新，例如增加数量的操作。</p>
<p>我们也说过文档是不可变的——它们不能被更改，只能被替换。<code>update</code> API<strong>必须</strong>遵循相同的规则。表面看来，我们似乎是局部更新了文档的位置，内部却是像我们之前说的一样简单的使用<code>update</code> API处理相同的<em>检索-修改-重建索引</em>流程，我们也减少了其他进程可能导致冲突的修改。</p>
<p>最简单的<code>update</code>请求表单接受一个局部文档参数<code>doc</code>，它会合并到现有文档中——对象合并在一起，存在的标量字段被覆盖，新字段被添加。举个例子，我们可以使用以下请求为博客添加一个<code>tags</code>字段和一个<code>views</code>字段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">POST /website/blog/1/_update</div><div class="line">&#123;</div><div class="line">   &quot;doc&quot; : &#123;</div><div class="line">      &quot;tags&quot; : [ &quot;testing&quot; ],</div><div class="line">      &quot;views&quot;: 0</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="使用脚本更新"><a href="#使用脚本更新" class="headerlink" title="使用脚本更新"></a>使用脚本更新</h5><p>脚本能够使用<code>update</code> API改变<code>_source</code>字段的内容，它在脚本内部以<code>ctx._source</code>表示。例如，我们可以使用脚本增加博客的<code>views</code>数量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">POST /website/blog/1/_update</div><div class="line">&#123;</div><div class="line">   &quot;script&quot; : &quot;ctx._source.views+=1&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">POST /website/blog/1/_update</div><div class="line">&#123;</div><div class="line">   &quot;script&quot; : &quot;ctx._source.tags+=new_tag&quot;,</div><div class="line">   &quot;params&quot; : &#123;</div><div class="line">      &quot;new_tag&quot; : &quot;search&quot;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="3-10-MGET"><a href="#3-10-MGET" class="headerlink" title="3.10 MGET"></a>3.10 MGET</h5><p>检索多个文档</p>
<p><code>mget</code> API参数是一个<code>docs</code>数组，数组的每个节点定义一个文档的<code>_index</code>、<code>_type</code>、<code>_id</code>元数据。如果你只想检索一个或几个确定的字段，也可以定义一个<code>_source</code>参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">POST /_mget</div><div class="line">&#123;</div><div class="line">   &quot;docs&quot; : [</div><div class="line">      &#123;</div><div class="line">         &quot;_index&quot; : &quot;website&quot;,</div><div class="line">         &quot;_type&quot; :  &quot;blog&quot;,</div><div class="line">         &quot;_id&quot; :    2</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">         &quot;_index&quot; : &quot;website&quot;,</div><div class="line">         &quot;_type&quot; :  &quot;pageviews&quot;,</div><div class="line">         &quot;_id&quot; :    1,</div><div class="line">         &quot;_source&quot;: &quot;views&quot;</div><div class="line">      &#125;</div><div class="line">   ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>响应体也包含一个<code>docs</code>数组，每个文档还包含一个响应，它们按照请求定义的顺序排列。每个这样的响应与单独使用<strong>get request</strong>响应体相同：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">   &quot;docs&quot; : [</div><div class="line">      &#123;</div><div class="line">         &quot;_index&quot; :   &quot;website&quot;,</div><div class="line">         &quot;_id&quot; :      &quot;2&quot;,</div><div class="line">         &quot;_type&quot; :    &quot;blog&quot;,</div><div class="line">         &quot;found&quot; :    true,</div><div class="line">         &quot;_source&quot; : &#123;</div><div class="line">            &quot;text&quot; :  &quot;This is a piece of cake...&quot;,</div><div class="line">            &quot;title&quot; : &quot;My first external blog entry&quot;</div><div class="line">         &#125;,</div><div class="line">         &quot;_version&quot; : 10</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">         &quot;_index&quot; :   &quot;website&quot;,</div><div class="line">         &quot;_id&quot; :      &quot;1&quot;,</div><div class="line">         &quot;_type&quot; :    &quot;pageviews&quot;,</div><div class="line">         &quot;found&quot; :    true,</div><div class="line">         &quot;_version&quot; : 2,</div><div class="line">         &quot;_source&quot; : &#123;</div><div class="line">            &quot;views&quot; : 2</div><div class="line">         &#125;</div><div class="line">      &#125;</div><div class="line">   ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="3-11-批量"><a href="#3-11-批量" class="headerlink" title="3.11 批量"></a>3.11 批量</h5><p><code>bulk</code>请求体如下，它有一点不同寻常：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123; action: &#123; metadata &#125;&#125;\n</div><div class="line">&#123; request body        &#125;\n</div><div class="line">&#123; action: &#123; metadata &#125;&#125;\n</div><div class="line">&#123; request body        &#125;\n</div><div class="line">...</div></pre></td></tr></table></figure>
<p>这种格式类似于用<code>&quot;\n&quot;</code>符号连接起来的一行一行的JSON文档<strong>流(stream)</strong>。两个重要的点需要注意：</p>
<ul>
<li>每行必须以<code>&quot;\n&quot;</code>符号结尾，<strong>包括最后一行</strong>。这些都是作为每行有效的分离而做的标记。</li>
<li>每一行的数据不能包含未被转义的换行符，它们会干扰分析——这意味着JSON不能被美化打印。</li>
</ul>
<p>删除操作不需要<strong>请求体(request body)</strong>。</p>
<p>每个子请求都被独立的执行，所以一个子请求的错误并不影响其它请求。如果任何一个请求失败，顶层的<code>error</code>标记将被设置为<code>true</code>，然后错误的细节将在相应的请求中被报告。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">POST /_bulk</div><div class="line">&#123; &quot;delete&quot;: &#123; &quot;_index&quot;: &quot;website&quot;, &quot;_type&quot;: &quot;blog&quot;, &quot;_id&quot;: &quot;123&quot; &#125;&#125; &lt;1&gt;</div><div class="line">&#123; &quot;create&quot;: &#123; &quot;_index&quot;: &quot;website&quot;, &quot;_type&quot;: &quot;blog&quot;, &quot;_id&quot;: &quot;123&quot; &#125;&#125;</div><div class="line">&#123; &quot;title&quot;:    &quot;My first blog post&quot; &#125;</div><div class="line">&#123; &quot;index&quot;:  &#123; &quot;_index&quot;: &quot;website&quot;, &quot;_type&quot;: &quot;blog&quot; &#125;&#125;</div><div class="line">&#123; &quot;title&quot;:    &quot;My second blog post&quot; &#125;</div><div class="line">&#123; &quot;update&quot;: &#123; &quot;_index&quot;: &quot;website&quot;, &quot;_type&quot;: &quot;blog&quot;, &quot;_id&quot;: &quot;123&quot;, &quot;_retry_on_conflict&quot; : 3&#125; &#125;</div><div class="line">&#123; &quot;doc&quot; : &#123;&quot;title&quot; : &quot;My updated blog post&quot;&#125; &#125;</div></pre></td></tr></table></figure>
<h3 id="5-搜索"><a href="#5-搜索" class="headerlink" title="5.搜索"></a>5.搜索</h3><p>5.1空搜索</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /_search</div></pre></td></tr></table></figure>
<p>返回结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">   &quot;hits&quot; : &#123;</div><div class="line">      &quot;total&quot; :       14,</div><div class="line">      &quot;hits&quot; : [</div><div class="line">        &#123;</div><div class="line">          &quot;_index&quot;:   &quot;us&quot;,</div><div class="line">          &quot;_type&quot;:    &quot;tweet&quot;,</div><div class="line">          &quot;_id&quot;:      &quot;7&quot;,</div><div class="line">          &quot;_score&quot;:   1,</div><div class="line">          &quot;_source&quot;: &#123;</div><div class="line">             &quot;date&quot;:    &quot;2014-09-17&quot;,</div><div class="line">             &quot;name&quot;:    &quot;John Smith&quot;,</div><div class="line">             &quot;tweet&quot;:   &quot;The Query DSL is really powerful and flexible&quot;,</div><div class="line">             &quot;user_id&quot;: 2</div><div class="line">          &#125;</div><div class="line">       &#125;,</div><div class="line">        ... 9 RESULTS REMOVED ...</div><div class="line">      ],</div><div class="line">      &quot;max_score&quot; :   1</div><div class="line">   &#125;,</div><div class="line">   &quot;took&quot; :           4,</div><div class="line">   &quot;_shards&quot; : &#123;</div><div class="line">      &quot;failed&quot; :      0,</div><div class="line">      &quot;successful&quot; :  10,</div><div class="line">      &quot;total&quot; :       10</div><div class="line">   &#125;,</div><div class="line">   &quot;timed_out&quot; :      false</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>5.2 多搜索和多索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/gb,us/user,tweet/_search</div></pre></td></tr></table></figure>
<p>5.3分页</p>
<p>Elasticsearch接受<code>from</code>和<code>size</code>参数：</p>
<p><code>size</code>: 结果数，默认<code>10</code></p>
<p><code>from</code>: 跳过开始的结果数，默认<code>0</code></p>
<p>5.4 查询字符串</p>
<p><code>search</code> API有两种表单：一种是“简易版”的<strong>查询字符串(query string)</strong>将所有参数通过查询字符串定义，另一种版本使用JSON完整的表示<strong>请求体(request body)</strong>，这种富搜索语言叫做结构化查询语句（DSL）</p>
<p>在<code>tweet</code>字段中包含<code>elasticsearch</code>字符。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /_all/tweet/_search?q=tweet:elasticsearch</div></pre></td></tr></table></figure>
<h3 id="6-映射和分析"><a href="#6-映射和分析" class="headerlink" title="6.映射和分析"></a>6.映射和分析</h3><h4 id="6-4-分析"><a href="#6-4-分析" class="headerlink" title="6.4 分析"></a>6.4 分析</h4><p>当我们<strong>索引(index)</strong>一个文档，全文字段会被分析为单独的词来创建倒排索引。不过，当我们在全文字段<strong>搜索(search)</strong>时，我们要让查询字符串经过<strong>同样的分析流程</strong>处理，以确保这些词在索引中存在。</p>
<ul>
<li>当你查询<strong>全文(full text)</strong>字段，查询将使用相同的分析器来分析查询字符串，以产生正确的词列表。</li>
<li>当你查询一个<strong>确切值(exact value)</strong>字段，查询将不分析查询字符串，但是你可以自己指定。</li>
</ul>
<h4 id="6-5-映射"><a href="#6-5-映射" class="headerlink" title="6.5 映射"></a>6.5 映射</h4><p><code>string</code>类型的字段，默认的，考虑到包含全文本，它们的值在索引前要经过分析器分析，并且在全文搜索此字段前要把查询语句做分析处理。</p>
<p>string类型默认进行analyze，即全文搜索。而其他字段则是精确匹配。</p>
<p>index</p>
<p>index参数控制字符串以何种方式被索引。</p>
<table>
<thead>
<tr>
<th>值</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>analyzed</code></td>
<td>首先分析这个字符串，然后索引。换言之，以全文形式索引此字段。</td>
</tr>
<tr>
<td><code>not_analyzed</code></td>
<td>索引这个字段，使之可以被搜索，但是索引内容和指定值一样。不分析此字段。</td>
</tr>
<tr>
<td><code>no</code></td>
<td>不索引这个字段。这个字段不能为搜索到。</td>
</tr>
</tbody>
</table>
<p><code>string</code>类型字段默认值是<code>analyzed</code>。如果我们想映射字段为确切值(即不分词)，我们需要设置它为<code>not_analyzed</code>。</p>
<p>分析</p>
<p>对于<code>analyzed</code>类型的字符串字段，使用<code>analyzer</code>参数来指定哪一种分析器将在搜索和索引的时候使用。默认的，Elasticsearch使用<code>standard</code>分析器。</p>
<h4 id="6-6-复合类型"><a href="#6-6-复合类型" class="headerlink" title="6.6 复合类型"></a>6.6 复合类型</h4><h5 id="多层对象"><a href="#多层对象" class="headerlink" title="多层对象"></a>多层对象</h5><p>内部对象(inner objects)经常用于在另一个对象中嵌入一个实体或对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;tweet&quot;:            &quot;Elasticsearch is very flexible&quot;,</div><div class="line">    &quot;user&quot;: &#123;</div><div class="line">        &quot;id&quot;:           &quot;@johnsmith&quot;,</div><div class="line">        &quot;gender&quot;:       &quot;male&quot;,</div><div class="line">        &quot;age&quot;:          26,</div><div class="line">        &quot;name&quot;: &#123;</div><div class="line">            &quot;full&quot;:     &quot;John Smith&quot;,</div><div class="line">            &quot;first&quot;:    &quot;John&quot;,</div><div class="line">            &quot;last&quot;:     &quot;Smith&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="内部对象的映射"><a href="#内部对象的映射" class="headerlink" title="内部对象的映射"></a>内部对象的映射</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;gb&quot;: &#123;</div><div class="line">    &quot;tweet&quot;: &#123; &lt;1&gt;</div><div class="line">      &quot;properties&quot;: &#123;</div><div class="line">        &quot;tweet&quot;:            &#123; &quot;type&quot;: &quot;string&quot; &#125;,</div><div class="line">        &quot;user&quot;: &#123; &lt;2&gt;</div><div class="line">          &quot;type&quot;:             &quot;object&quot;,</div><div class="line">          &quot;properties&quot;: &#123;</div><div class="line">            &quot;id&quot;:           &#123; &quot;type&quot;: &quot;string&quot; &#125;,</div><div class="line">            &quot;gender&quot;:       &#123; &quot;type&quot;: &quot;string&quot; &#125;,</div><div class="line">            &quot;age&quot;:          &#123; &quot;type&quot;: &quot;long&quot;   &#125;,</div><div class="line">            &quot;name&quot;:   &#123; &lt;3&gt;</div><div class="line">              &quot;type&quot;:         &quot;object&quot;,</div><div class="line">              &quot;properties&quot;: &#123;</div><div class="line">                &quot;full&quot;:     &#123; &quot;type&quot;: &quot;string&quot; &#125;,</div><div class="line">                &quot;first&quot;:    &#123; &quot;type&quot;: &quot;string&quot; &#125;,</div><div class="line">                &quot;last&quot;:     &#123; &quot;type&quot;: &quot;string&quot; &#125;</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><1> 根对象.</1></p>
<p><2><3> 内部对象.</3></2></p>
<h5 id="内部对象怎么被索引"><a href="#内部对象怎么被索引" class="headerlink" title="内部对象怎么被索引"></a>内部对象怎么被索引</h5><p>Lucene 并不了解内部对象。 一个 Lucene 文件包含一个键-值对应的扁平表单。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;tweet&quot;:            [elasticsearch, flexible, very],</div><div class="line">    &quot;user.id&quot;:          [@johnsmith],</div><div class="line">    &quot;user.gender&quot;:      [male],</div><div class="line">    &quot;user.age&quot;:         [26],</div><div class="line">    &quot;user.name.full&quot;:   [john, smith],</div><div class="line">    &quot;user.name.first&quot;:  [john],</div><div class="line">    &quot;user.name.last&quot;:   [smith]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="7-结构化查询"><a href="#7-结构化查询" class="headerlink" title="7.结构化查询"></a>7.结构化查询</h3><p>7.2结构化查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;bool&quot;: &#123;</div><div class="line">        &quot;must&quot;: &#123; &quot;match&quot;:      &#123; &quot;email&quot;: &quot;business opportunity&quot; &#125;&#125;,</div><div class="line">        &quot;should&quot;: [</div><div class="line">             &#123; &quot;match&quot;:         &#123; &quot;starred&quot;: true &#125;&#125;,</div><div class="line">             &#123; &quot;bool&quot;: &#123;</div><div class="line">                   &quot;must&quot;:      &#123; &quot;folder&quot;: &quot;inbox&quot; &#125;&#125;,</div><div class="line">                   &quot;must_not&quot;:  &#123; &quot;spam&quot;: true &#125;&#125;</div><div class="line">             &#125;&#125;</div><div class="line">        ],</div><div class="line">        &quot;minimum_should_match&quot;: 1</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>7.3查询与过滤</p>
<p>原则上来说，使用查询语句做全文本搜索或其他需要进行相关性评分的时候，剩下的全部用过滤语句。</p>
<p>一条过滤语句会询问每个文档的字段值是否包含着特定值：</p>
<ul>
<li><code>created</code> 的日期范围是否在 <code>2013</code> 到 <code>2014</code> ?</li>
<li><code>status</code> 字段中是否包含单词 “published” ?</li>
<li><code>lat_lon</code> 字段中的地理位置与目标点相距是否不超过10km ?</li>
</ul>
<p>一条查询语句与过滤语句相似，但问法不同：</p>
<p>查询语句会询问每个文档的字段值与特定值的匹配程度如何？</p>
<p>查询语句的典型用法是为了找到文档：</p>
<ul>
<li>查找与 <code>full text search</code> 这个词语最佳匹配的文档</li>
<li>查找包含单词 <code>run</code> ，但是也包含<code>runs</code>, <code>running</code>, <code>jog</code> 或 <code>sprint</code>的文档</li>
<li>同时包含着 <code>quick</code>, <code>brown</code> 和 <code>fox</code> — 单词间离得越近，该文档的相关性越高</li>
<li>标识着 <code>lucene</code>, <code>search</code> 或 <code>java</code> — 标识词越多，该文档的相关性越高</li>
</ul>
<p>7.4重要的查询过滤子句</p>
<p>term过滤</p>
<blockquote>
<p><code>term</code>主要用于精确匹配哪些值，比如数字，日期，布尔值或 <code>not_analyzed</code>的字符串(未经分析的文本数据类型)</p>
</blockquote>
<p>terms过滤</p>
<blockquote>
<p><code>terms</code> 跟 <code>term</code> 有点类似，但 <code>terms</code> 允许指定多个匹配条件。 如果某个字段指定了多个值，那么文档需要一起去做匹配。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;terms&quot;: &#123;</div><div class="line">        &quot;tag&quot;: [ &quot;search&quot;, &quot;full_text&quot;, &quot;nosql&quot; ]</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>range过滤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;range&quot;: &#123;</div><div class="line">        &quot;age&quot;: &#123;</div><div class="line">            &quot;gte&quot;:  20,</div><div class="line">            &quot;lt&quot;:   30</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>exists和missing过滤</p>
<p><code>exists</code> 和 <code>missing</code> 过滤可以用于查找文档中是否包含指定字段或没有某个字段，类似于SQL语句中的<code>IS_NULL</code>条件。</p>
<p>这两个过滤只是针对已经查出一批数据来，但是想区分出某个字段是否存在的时候使用。</p>
<p>bool过滤</p>
<p>match_all查询</p>
<p>match查询</p>
<blockquote>
<p><code>match</code>查询是一个标准查询，不管你需要全文本查询还是精确查询基本上都要用到它。</p>
<p>如果你使用 <code>match</code> 查询一个全文本字段，它会在真正查询之前用分析器先分析<code>match</code>一下查询字符。</p>
<p>如果用<code>match</code>下指定了一个确切值，在遇到数字，日期，布尔值或者<code>not_analyzed</code> 的字符串时，它将为你搜索你给定的值。</p>
<p>做精确匹配搜索时，你最好用过滤语句，因为过滤语句可以缓存数据。</p>
</blockquote>
<p>multi_match 查询</p>
<blockquote>
<p><code>multi_match</code>查询允许你做<code>match</code>查询的基础上同时搜索多个字段：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;multi_match&quot;: &#123;</div><div class="line">        &quot;query&quot;:    &quot;full text search&quot;,</div><div class="line">        &quot;fields&quot;:   [ &quot;title&quot;, &quot;body&quot; ]</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>bool查询</p>
<blockquote>
<p><code>bool</code> 查询与 <code>bool</code> 过滤相似，用于合并多个查询子句。不同的是，<code>bool</code> 过滤可以直接给出是否匹配成功， 而<code>bool</code> 查询要计算每一个查询子句的 <code>_score</code> （相关性分值）。</p>
</blockquote>
<p>7.5 过滤与查询</p>
<p><code>search</code> API中只能包含 <code>query</code> 语句，所以我们需要用 <code>filtered</code> 来同时包含 “query” 和 “filter” 子句。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;filtered&quot;: &#123;</div><div class="line">        &quot;query&quot;:  &#123; &quot;match&quot;: &#123; &quot;email&quot;: &quot;business opportunity&quot; &#125;&#125;,</div><div class="line">        &quot;filter&quot;: &#123; &quot;term&quot;:  &#123; &quot;folder&quot;: &quot;inbox&quot; &#125;&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们在外层再加入 <code>query</code> 的上下文关系：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot;: &#123;</div><div class="line">        &quot;filtered&quot;: &#123;</div><div class="line">            &quot;query&quot;:  &#123; &quot;match&quot;: &#123; &quot;email&quot;: &quot;business opportunity&quot; &#125;&#125;,</div><div class="line">            &quot;filter&quot;: &#123; &quot;term&quot;: &#123; &quot;folder&quot;: &quot;inbox&quot; &#125;&#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>7.6验证查询</p>
<p><code>validate</code> API 可以验证一条查询语句是否合法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">GET /gb/tweet/_validate/query</div><div class="line">&#123;</div><div class="line">   &quot;query&quot;: &#123;</div><div class="line">      &quot;tweet&quot; : &#123;</div><div class="line">         &quot;match&quot; : &quot;really powerful&quot;</div><div class="line">      &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>想知道语句非法的具体错误信息，需要加上 <code>explain</code> 参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">GET /gb/tweet/_validate/query?explain &lt;1&gt;</div><div class="line">&#123;</div><div class="line">   &quot;query&quot;: &#123;</div><div class="line">      &quot;tweet&quot; : &#123;</div><div class="line">         &quot;match&quot; : &quot;really powerful&quot;</div><div class="line">      &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>explain参数可以帮助我们理解语句是否正确。</p>
<h3 id="8-排序"><a href="#8-排序" class="headerlink" title="8.排序"></a>8.排序</h3><p>8.2.字符串排序</p>
<p>为了使一个string字段可以进行排序，它必须只包含一个词：即完整的<code>not_analyzed</code>字符串(译者注：未经分析器分词并排序的原字符串)。 当然我们需要对字段进行全文本搜索的时候还必须使用被 <code>analyzed</code> 标记的字段。</p>
<p>在 <code>_source</code> 下相同的字符串上排序两次会造成不必要的资源浪费。 而我们想要的是同一个字段中同时包含这两种索引方式，我们只需要改变索引(index)的mapping即可。 方法是在所有核心字段类型上，使用通用参数 <code>fields</code>对mapping进行修改。 比如，我们原有mapping如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&quot;tweet&quot;: &#123;</div><div class="line">    &quot;type&quot;:     &quot;string&quot;,</div><div class="line">    &quot;analyzer&quot;: &quot;english&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>改变后的多值字段mapping如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&quot;tweet&quot;: &#123; &lt;1&gt;</div><div class="line">    &quot;type&quot;:     &quot;string&quot;,</div><div class="line">    &quot;analyzer&quot;: &quot;english&quot;,</div><div class="line">    &quot;fields&quot;: &#123;</div><div class="line">        &quot;raw&quot;: &#123; &lt;2&gt;</div><div class="line">            &quot;type&quot;:  &quot;string&quot;,</div><div class="line">            &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><1> <code>tweet</code> 字段用于全文本的 <code>analyzed</code> 索引方式不变。</1></p>
<p><2> 新增的 <code>tweet.raw</code> 子字段索引方式是 <code>not_analyzed</code>。</2></p>
<p>现在，在给数据重建索引后，我们既可以使用 <code>tweet</code> 字段进行全文本搜索，也可以用<code>tweet.raw</code>字段进行排序：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot;: &#123;</div><div class="line">        &quot;match&quot;: &#123;</div><div class="line">            &quot;tweet&quot;: &quot;elasticsearch&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;sort&quot;: &quot;tweet.raw&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><strong>警告</strong>： 对 <code>analyzed</code> 字段进行强制排序会消耗大量内存。</p>
</blockquote>
<p>8.3相关性</p>
<h5 id="理解评分"><a href="#理解评分" class="headerlink" title="理解评分"></a>理解评分</h5><p>当调试一条复杂的查询语句时，想要理解相关性评分 <code>_score</code> 是比较困难的。ElasticSearch 在 每个查询语句中都有一个explain参数，将 <code>explain</code> 设为 <code>true</code> 就可以得到更详细的信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">GET /_search?explain &lt;1&gt;</div><div class="line">&#123;</div><div class="line">   &quot;query&quot;   : &#123; &quot;match&quot; : &#123; &quot;tweet&quot; : &quot;honeymoon&quot; &#125;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><1> <code>explain</code> 参数可以让返回结果添加一个 <code>_score</code> 评分的得来依据。</1></p>
<p><strong>提示</strong>： JSON形式的explain描述是难以阅读的 但是转成 YAML 会好很多，只需要在参数中加上<code>format=yaml</code></p>
<h5 id="Explain-api"><a href="#Explain-api" class="headerlink" title="Explain api"></a>Explain api</h5><p>当<code>explain</code>选项加到某一文档上时，它会告诉你为何这个文档会被匹配，以及一个文档为何没有被匹配。如请求路径为 <code>/index/type/id/_explain</code>。</p>
<h3 id="10-索引管理"><a href="#10-索引管理" class="headerlink" title="10.索引管理"></a>10.索引管理</h3><h5 id="10-1-创建删除"><a href="#10-1-创建删除" class="headerlink" title="10.1 创建删除"></a>10.1 创建删除</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">PUT /my_index</div><div class="line">&#123;</div><div class="line">    &quot;settings&quot;: &#123; ... any settings ... &#125;,</div><div class="line">    &quot;mappings&quot;: &#123;</div><div class="line">        &quot;type_one&quot;: &#123; ... any mappings ... &#125;,</div><div class="line">        &quot;type_two&quot;: &#123; ... any mappings ... &#125;,</div><div class="line">        ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h5 id="10-3配置分析器"><a href="#10-3配置分析器" class="headerlink" title="10.3配置分析器"></a>10.3配置分析器</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">GET /spanish_docs/_analyze?analyzer=es_std</div><div class="line">El veloz zorro marrón</div></pre></td></tr></table></figure>
<h5 id="10-7-元数据中的source字段"><a href="#10-7-元数据中的source字段" class="headerlink" title="10.7 元数据中的source字段"></a>10.7 元数据中的source字段</h5><p>禁用_source字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">PUT /my_index</div><div class="line">&#123;</div><div class="line">    &quot;mappings&quot;: &#123;</div><div class="line">        &quot;my_type&quot;: &#123;</div><div class="line">            &quot;_source&quot;: &#123;</div><div class="line">                &quot;enabled&quot;:  false</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>限制返回的字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot;:   &#123; &quot;match_all&quot;: &#123;&#125;&#125;,</div><div class="line">    &quot;_source&quot;: [ &quot;title&quot;, &quot;created&quot; ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="10-8-元数据中的all字段"><a href="#10-8-元数据中的all字段" class="headerlink" title="10.8 元数据中的all字段"></a>10.8 元数据中的all字段</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;match&quot;: &#123;</div><div class="line">        &quot;_all&quot;: &quot;john smith marketing&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="12-结构化搜索"><a href="#12-结构化搜索" class="headerlink" title="12.结构化搜索"></a>12.结构化搜索</h3><p>通过结构化搜索，你的查询结果<em>始终</em>是 是或非；是否应该属于集合。结构化搜索不关心文档的相关性或分数，它只是简单的包含或排除文档。</p>
<p>过滤器filter有term(terms)，bool，range等等。</p>
<h5 id="12-1查询准确值"><a href="#12-1查询准确值" class="headerlink" title="12.1查询准确值"></a>12.1查询准确值</h5><p>当term用于查询字符串的时候，记得把term里面field设为not analyzed.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">GET /my_store/products/_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;filtered&quot; : &#123;</div><div class="line">            &quot;filter&quot; : &#123;</div><div class="line">                &quot;term&quot; : &#123;</div><div class="line">                    &quot;productID&quot; : &quot;XHDK-A-1293-#fJ3&quot;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>term(terms)是包含操作，不是等于操作。</p>
<h5 id="12-2-组合过滤"><a href="#12-2-组合过滤" class="headerlink" title="12.2 组合过滤"></a>12.2 组合过滤</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">GET /my_store/products/_search</div><div class="line">&#123;</div><div class="line">   &quot;query&quot; : &#123;</div><div class="line">      &quot;filtered&quot; : &#123; &lt;1&gt;</div><div class="line">         &quot;filter&quot; : &#123;</div><div class="line">            &quot;bool&quot; : &#123;</div><div class="line">              &quot;should&quot; : [</div><div class="line">                 &#123; &quot;term&quot; : &#123;&quot;price&quot; : 20&#125;&#125;, &lt;2&gt;</div><div class="line">                 &#123; &quot;term&quot; : &#123;&quot;productID&quot; : &quot;XHDK-A-1293-#fJ3&quot;&#125;&#125; &lt;2&gt;</div><div class="line">              ],</div><div class="line">              &quot;must_not&quot; : &#123;</div><div class="line">                 &quot;term&quot; : &#123;&quot;price&quot; : 30&#125; &lt;3&gt;</div><div class="line">              &#125;</div><div class="line">           &#125;</div><div class="line">         &#125;</div><div class="line">      &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="12-3查询多个准确值"><a href="#12-3查询多个准确值" class="headerlink" title="12.3查询多个准确值"></a>12.3查询多个准确值</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">GET /my_store/products/_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot; : &#123;</div><div class="line">        &quot;filtered&quot; : &#123;</div><div class="line">            &quot;filter&quot; : &#123;</div><div class="line">                &quot;terms&quot; : &#123; &lt;1&gt;</div><div class="line">                    &quot;price&quot; : [20, 30]</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="12-4-包含而不是相等"><a href="#12-4-包含而不是相等" class="headerlink" title="12.4 包含而不是相等"></a>12.4 包含而不是相等</h5><p>假如你有一个 term 过滤器 <code>{ &quot;term&quot; : { &quot;tags&quot; : &quot;search&quot; } }</code>，它将匹配下面两个文档：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&#123; &quot;tags&quot; : [&quot;search&quot;] &#125;</div><div class="line">&#123; &quot;tags&quot; : [&quot;search&quot;, &quot;open_source&quot;] &#125; &lt;1&gt;</div></pre></td></tr></table></figure>
<p><1> 虽然这个文档除了 <code>search</code> 还有其他短语，它还是被返回了</1></p>
<p><code>term</code> 和 <code>terms</code> 是 <em>必须包含</em> 操作，而不是 <em>必须相等</em>。</p>
<h4 id="完全匹配"><a href="#完全匹配" class="headerlink" title="完全匹配"></a>完全匹配</h4><p>假如你真的需要完全匹配这种行为，最好是通过添加另一个字段来实现。在这个字段中，你索引原字段包含值的个数。引用上面的两个文档，我们现在包含一个字段来记录标签的个数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&#123; &quot;tags&quot; : [&quot;search&quot;], &quot;tag_count&quot; : 1 &#125;</div><div class="line">&#123; &quot;tags&quot; : [&quot;search&quot;, &quot;open_source&quot;], &quot;tag_count&quot; : 2 &#125;</div></pre></td></tr></table></figure>
<p>一旦你索引了标签个数，你可以构造一个 <code>bool</code> 过滤器来限制短语个数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">GET /my_index/my_type/_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot;: &#123;</div><div class="line">        &quot;filtered&quot; : &#123;</div><div class="line">            &quot;filter&quot; : &#123;</div><div class="line">                 &quot;bool&quot; : &#123;</div><div class="line">                    &quot;must&quot; : [</div><div class="line">                        &#123; &quot;term&quot; : &#123; &quot;tags&quot; : &quot;search&quot; &#125; &#125;, &lt;1&gt;</div><div class="line">                        &#123; &quot;term&quot; : &#123; &quot;tag_count&quot; : 1 &#125; &#125; &lt;2&gt;</div><div class="line">                    ]</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="12-5范围"><a href="#12-5范围" class="headerlink" title="12.5范围"></a>12.5范围</h5><p>Elasticsearch 有一个 <code>range</code> 过滤器，让你可以根据范围过滤：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&quot;range&quot; : &#123;</div><div class="line">    &quot;price&quot; : &#123;</div><div class="line">        &quot;gt&quot; : 20,</div><div class="line">        &quot;lt&quot; : 40</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>range</code> 过滤器既能包含也能排除范围，通过下面的选项：</p>
<ul>
<li><code>gt</code>: <code>&gt;</code> 大于</li>
<li><code>lt</code>: <code>&lt;</code> 小于</li>
<li><code>gte</code>: <code>&gt;=</code> 大于或等于</li>
<li><code>lte</code>: <code>&lt;=</code> 小于或等于</li>
</ul>
<p><code>range</code> 过滤器也可以用于日期字段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&quot;range&quot; : &#123;</div><div class="line">    &quot;timestamp&quot; : &#123;</div><div class="line">        &quot;gt&quot; : &quot;2014-01-01 00:00:00&quot;,</div><div class="line">        &quot;lt&quot; : &quot;2014-01-07 00:00:00&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当用于日期字段时，<code>range</code> 过滤器支持<em>日期数学</em>操作。例如，我们想找到所有最近一个小时的文档：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&quot;range&quot; : &#123;</div><div class="line">    &quot;timestamp&quot; : &#123;</div><div class="line">        &quot;gt&quot; : &quot;now-1h&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个过滤器将始终能找出所有时间戳大于当前时间减 1 小时的文档，让这个过滤器像<em>移窗</em>一样通过你的文档。</p>
<p>日期计算也能用于实际的日期，而不是仅仅是一个像 now 一样的占位符。只要在日期后加上双竖线 <code>||</code>，就能使用日期数学表达式了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&quot;range&quot; : &#123;</div><div class="line">    &quot;timestamp&quot; : &#123;</div><div class="line">        &quot;gt&quot; : &quot;2014-01-01 00:00:00&quot;,</div><div class="line">        &quot;lt&quot; : &quot;2014-01-01 00:00:00||+1M&quot; &lt;1&gt;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><1> 早于 2014 年 1 月 1 号加一个月</1></p>
<h5 id="12-8-过滤顺序"><a href="#12-8-过滤顺序" class="headerlink" title="12.8 过滤顺序"></a>12.8 过滤顺序</h5><p>在 <code>bool</code> 条件中过滤器的顺序对性能有很大的影响。更详细的过滤条件应该被放置在其他过滤器之前，以便在更早的排除更多的文档。</p>
<p>假如条件 A 匹配 1000 万个文档，而 B 只匹配 100 个文档，那么需要将 B 放在 A 前面。</p>
<p>缓存的过滤器非常快，所以它们需要被放在不能缓存的过滤器之前。</p>
<h3 id="13-全文检索"><a href="#13-全文检索" class="headerlink" title="13.全文检索"></a>13.全文检索</h3><p><em>全文检索</em>：怎样对全文字段(full-text fields)进行检索以找到相关度最高的文档。</p>
<p>全文检索最重要的两个方面是：</p>
<ul>
<li><p>相关度(Relevance)</p>
<p>根据文档与查询的相关程度对结果集进行排序的能力。相关度可以使用TF/IDF、地理位置相近程度、模糊相似度或其他算法计算。</p>
</li>
<li><p>分析(Analysis)</p>
<p>将一段文本转换为一组唯一的、标准化了的标记(token)，用以(a)创建倒排索引，(b)查询倒排索引。</p>
</li>
</ul>
<p>注意，一旦提到相关度和分析，指的都是查询(queries)而非过滤器(filters)。</p>
<p>准确值(<code>&#39;not_analyzed&#39;</code>)  全文(<code>&#39;analyzed&#39;</code>)</p>
<p>1.基于短语的查询</p>
<p>不会有分析阶段。这些查询在单一的短语上执行，<code>term</code>查询只在倒排查询里精确地查找特定短语（或者说精确包含），而不会匹配短语的其它变形。</p>
<p>2.全文检索</p>
<p><code>match</code>和<code>query_string</code>这样的查询是高级查询，它们会对字段进行分析：</p>
<ul>
<li><p>如果检索一个<code>&#39;date&#39;</code>或<code>&#39;integer&#39;</code>字段，它们会把查询语句作为日期或者整数格式数据。</p>
</li>
<li><p>如果检索一个准确值(<code>&#39;not_analyzed&#39;</code>)字符串字段，它们会把整个查询语句作为一个短语。</p>
</li>
<li><p>如果检索一个全文(<code>&#39;analyzed&#39;</code>)字段，查询会先用适当的解析器解析查询语句，产生需要查询的短语列表。然后对列表中的每个短语执行低级查询，合并查询结果，得到最终的文档相关度。</p>
<p>我们很少需要直接使用基于短语的查询。通常我们会想要检索全文，而不是单独的短语，使用高级的全文检索会更简单（全文检索内部最终还是使用基于短语的查询）。</p>
<p>如果确实要查询一个准确值字段(<code>&#39;not_analyzed&#39;</code>)，需要考虑使用查询还是过滤器。</p>
<p>[提示] 单一短语的查询通常相当于<strong>是/否</strong>问题，用过滤器可以更好的描述这类查询，并且过滤器缓存可以提升性能：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">    &quot;query&quot;: &#123;</div><div class="line">        &quot;filtered&quot;: &#123;</div><div class="line">            &quot;filter&quot;: &#123;</div><div class="line">                &quot;term&quot;: &#123; &quot;gender&quot;: &quot;female&quot; &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="分析器"><a href="#分析器" class="headerlink" title="分析器"></a>分析器</h5><p>有时，在索引时和搜索时使用不同的分析器是合理的。比如，在索引时我们希望索引到同义词（在quick出现的地方，我们希望同时索引fast，rapid和speedy）。但在搜索时，我们不需要搜索所有的同义词。我们只需要关注用户输入的单词，无论是quick，fast，rapid，还是speedy，输入什么就是什么。</p>
<p>为了区分，ElasticSearch支持参数 <em>index_analyzer</em> 和 <em>search_analyzer</em>，以及 <em>default_index</em> 和 <em>default_search</em>的分析器。</p>
<h5 id="被破坏的相关度（Relevance-is-Broken）"><a href="#被破坏的相关度（Relevance-is-Broken）" class="headerlink" title="被破坏的相关度（Relevance is Broken）"></a>被破坏的相关度（Relevance is Broken）</h5><p>在我们讨论更复杂的多字段查询之前，这里先解释一下为什么我们将测试数据只创建在一个主分片上（primary shard）。</p>
<p>用户会时不时的抱怨遇到这样的问题：用户索引了一些文档，运行了一个简单的查询，然后明显发现一些低相关性的结果出现在高相关性结果之上。</p>
<p>为了理解为什么会这样，我们可以想象一下，我们在两个主分片上创建了索引，总共10个文档，其中6个文档有单词<em>foo</em>，可能是shard 1有其中3个文档，而shard 2有其中另外3个文档，换句话说，所有文档是均匀分布存储的。</p>
<p>在何为相关性中，我们描述了ElasticSearch默认的相似度算法，这个算法叫做 TF/IDF (term frequency/inverse document frequency)。详细参照之前提到的内容。</p>
<p>但是由于性能原因，ElasticSearch在计算IDF时，不会计算所有的文档。相反，每个分片会根据该分片的所有文档，计算一个本地的IDF。</p>
<p>因为我们的文档是均匀的分布存储的，每个shard的IDF是相同的。如果有5个文档存在于shard 1，而第6个文档存在于shard 2，在这种场景下，foo在一个shard里非常普通（所以不那么重要），但是在另个shard里非常少（所以会显得更重要）。这样局部IDF的差异会导致不正确的结果。</p>
<p>在实际中，这不是一个问题，本地和全局的IDF的差异随着索引里文档数的增多会渐渐消失，在真实世界的数据量下，局部的IDF会迅速被均化，所以这里的问题并不是相关性被破坏了，而是数据量太小了。</p>
<p>为了测试，我们可以通过两种方式解决这个问题。第一种是只在主分片上创建索引，就如我们例子里做的那样，如果只有一个shard，那么本地的IDF就是全局的IDF。</p>
<p>第二个方式就是在搜索请求后添加 <em>?search_type=dfs_query_then_fetch</em>，<em>dfs</em> 是指 分布式频率搜索（Distributed Frequency Search），它告诉ElasticSearch，先分别获得每个shard本地的IDF，然后根据结果再计算全局的IDF。</p>
<blockquote>
<p>注意：<br>不要在产品上使用第二种方式，我们完全无须如此。</p>
</blockquote>
<h3 id="14-多字段搜索"><a href="#14-多字段搜索" class="headerlink" title="14.多字段搜索"></a>14.多字段搜索</h3><h5 id="14-1多字符串查询"><a href="#14-1多字符串查询" class="headerlink" title="14.1多字符串查询"></a>14.1多字符串查询</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">GET /_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;bool&quot;: &#123;</div><div class="line">      &quot;should&quot;: [</div><div class="line">        &#123; &quot;match&quot;: &#123; (1)</div><div class="line">            &quot;title&quot;:  &#123;</div><div class="line">              &quot;query&quot;: &quot;War and Peace&quot;,</div><div class="line">              &quot;boost&quot;: 2</div><div class="line">        &#125;&#125;&#125;,</div><div class="line">        &#123; &quot;match&quot;: &#123; (1)</div><div class="line">            &quot;author&quot;:  &#123;</div><div class="line">              &quot;query&quot;: &quot;Leo Tolstoy&quot;,</div><div class="line">              &quot;boost&quot;: 2</div><div class="line">        &#125;&#125;&#125;,</div><div class="line">        &#123; &quot;bool&quot;:  &#123; (2)</div><div class="line">            &quot;should&quot;: [</div><div class="line">              &#123; &quot;match&quot;: &#123; &quot;translator&quot;: &quot;Constance Garnett&quot; &#125;&#125;,</div><div class="line">              &#123; &quot;match&quot;: &#123; &quot;translator&quot;: &quot;Louise Maude&quot;      &#125;&#125;</div><div class="line">            ]</div><div class="line">        &#125;&#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为什么将译者条件语句放入另一个独立的 <em>bool</em> 查询中呢？所有的4个 <em>match</em> 查询都是 <em>should</em> 语句，我们为什么不将translator语句与其他语句（如 <em>title</em>、<em>author</em>）放在同一层呢？</p>
<p>答案在于分数的计算方式。<em>bool</em> 查询执行每个 <em>match</em> 查询，然后把他们加在一起，然后将结果与所有匹配的语句数量相乘，再除以所有的语句数量。处于同一层的每条语句具有相同的权重。在上面这个例子中，包含<em>translator</em>语句的 <em>bool</em> 查询，只占总分数的三分之一，如果我们将<em>translator</em>语句与 <em>title</em> 和 <em>author</em> 两个语句放入同一层，那么 <em>title</em> 和 <em>author</em> 语句只贡献四分之一。</p>
<h5 id="14-2单一查询字符串"><a href="#14-2单一查询字符串" class="headerlink" title="14.2单一查询字符串"></a>14.2单一查询字符串</h5><h3 id="近似度匹配"><a href="#近似度匹配" class="headerlink" title="近似度匹配"></a>近似度匹配</h3><h3 id="部分匹配"><a href="#部分匹配" class="headerlink" title="部分匹配"></a>部分匹配</h3><h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><p><a href="http://blog.csdn.net/helllochun/article/details/52136954" target="_blank" rel="external">elasticsearch 设置 mapping 时的 store 属性</a></p>
<p><a href="http://chattool.sinaapp.com/?p=248" target="_blank" rel="external">elasticsearch的store属性跟_source字段</a></p>
<p>后续的翻译：</p>
<p><a href="http://blog.csdn.net/dm_vincent/article/category/2718099" target="_blank" rel="external">Elasticsearch权威指南翻译目录</a></p>
<p><a href="http://www.cnblogs.com/richaaaard/p/5254285.html" target="_blank" rel="external">ElasticSearch 2 (17) - 深入搜索系列之部分匹配</a></p>
<h3 id="对权威指南的总结博客"><a href="#对权威指南的总结博客" class="headerlink" title="对权威指南的总结博客"></a>对权威指南的总结博客</h3><p><a href="http://slixurd.github.io/2015/09/10/ElasticSearchQueryAndFilter/" target="_blank" rel="external">ElasticSearch的搜索和过滤</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/15/elk/" itemprop="url">
                  elk
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-15T16:00:56+08:00" content="2016-10-15">
              2016-10-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/elk/" itemprop="url" rel="index">
                    <span itemprop="name">elk</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/15/elk/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/15/elk/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ELK"><a href="#ELK" class="headerlink" title="ELK"></a>ELK</h1><p>1.</p>
<p><a href="http://www.person168.com/?p=252" target="_blank" rel="external">spring mvc+ELK从头开始搭建日志平台</a></p>
<p>2.</p>
<p><a href="http://www.cnblogs.com/never-give-up-1015/p/5720488.html" target="_blank" rel="external">Nlog、elasticsearch、Kibana以及logstash在项目中的应用（二）</a></p>
<p>3.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/15/spring-data-elasticsearch/" itemprop="url">
                  spring-data-elasticsearch
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-15T15:50:52+08:00" content="2016-10-15">
              2016-10-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/spring-data-elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">spring-data-elasticsearch</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/15/spring-data-elasticsearch/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/15/spring-data-elasticsearch/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="spring-data-elasticsearch"><a href="#spring-data-elasticsearch" class="headerlink" title="spring-data-elasticsearch"></a>spring-data-elasticsearch</h3><p><a href="http://www.tianshouzhi.com/api/tutorials/springboot/101" target="_blank" rel="external"> SpringBoot整合ElasticSearch</a></p>
<p>gitbook :</p>
<p><a href="https://www.gitbook.com/book/giraffe0813/spring-data-elasticsearch/details" target="_blank" rel="external">Spring-Data-Elasticsearch</a></p>
<p><a href="http://www.wtoutiao.com/p/17eEGh5.html" target="_blank" rel="external">如何在Spring中注入ElasticSearch实例</a></p>
<p><a href="http://www.tianshouzhi.com/api/tutorials/elasticsearch/159" target="_blank" rel="external">入门整合案例(SpringBoot+Spring-data-elasticsearch)</a></p>
<p><a href="http://blog.csdn.net/u014201191/article/details/46508311" target="_blank" rel="external">elasticsearch spring 集成</a></p>
<p><a href="http://liuxi.name/blog/20160803/spring-data-es.html" target="_blank" rel="external">Spring Data ElasticSearch</a></p>
<p><a href="https://my.oschina.net/original123/blog/687348" target="_blank" rel="external">spring data 对elasticsearch的支持</a></p>
<p><a href="http://www.voidcn.com/blog/geloin/article/p-4137346.html" target="_blank" rel="external">集成Spring、Elasticsearch、paoding，将ES服务嵌入到Web程序</a></p>
<p><a href="https://www.ibm.com/developerworks/cn/java/j-lo-Spring-Elasticsearch-Logstash/" target="_blank" rel="external">使用 Spring、Elasticsearch 及 Logstash 构建企业级数据搜索和分析平台</a></p>
<p><a href="https://segmentfault.com/a/1190000004389565" target="_blank" rel="external">elasticsearch初探</a></p>
<p>项目实例：</p>
<p><a href="https://my.oschina.net/gaoguofan/blog/753401" target="_blank" rel="external">elasticsearch spring 集成</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Qi Liu" />
          <p class="site-author-name" itemprop="name">Qi Liu</p>
          <p class="site-description motion-element" itemprop="description">Less is More</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">62</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">38</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">52</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Qi Liu</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"nextinnovationucas"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>
